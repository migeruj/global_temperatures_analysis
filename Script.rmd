---
title: 'Actividad1 Temperatura Global de la superficie Terrestre'
author: "Miguel Eugenio Jurado Garcia - Aranoly Morales"
date: "September 09, 2022"
output:
  word_document: default
  pdf_document:
    fig_width: 3
    fig_height: 2
---

```{r message=FALSE}
tinytex::install_tinytex(force=TRUE)
install.packages(c("ggplot2","lubridate","plotly","data.table","ggthemes","patchwork","gridExtra","corrplot","dplyr","devtools","moments","car"), repos="http://cran.us.r-project.org")
library(ggplot2)
library(lubridate)
library(ggthemes)
library(data.table)
library(plotly)
library(patchwork)
library(gridExtra)
library(corrplot)
library(dplyr)
library(moments)
library(car)
```

# Temperatura global de la superficie de la tierra

## Motivación del Proyecto

El calentamiento global es una problemática que nos concierne a todos debido a su impacto de alguna o otra forma. La principal metrica de preocupacion en el aumento del promedio de la temperatura global. La base de datos tiene las temperaturas de la superficie terrestre, no se tiene variables relativas del aire ni de precipitacion, velocidad del viento u otras.

## Objetivos:

1.  Estudiar las caracteristicas en la prediccion de la temperatura

2.  Agrupar por clustering los calculos de diferencia al a

## Base de datos

Variable Objetivo:

Descripcion de los datos originales:

-   Date: starts in 1750 for average land temperature and 1850 for max and min land temperatures and global ocean and land temperatures
-   LandAverageTemperature: global average land temperature in celsius
-   LandAverageTemperatureUncertainty: the 95% confidence interval around the average
-   LandMaxTemperature: global average maximum land temperature in celsius
-   LandMaxTemperatureUncertainty: the 95% confidence interval around the maximum land temperature
-   LandMinTemperature: global average minimum land temperature in celsius
-   LandMinTemperatureUncertainty: the 95% confidence interval around the minimum land temperature
-   LandAndOceanAverageTemperature: global average land and ocean temperature in celsius
-   LandAndOceanAverageTemperatureUncertainty: the 95% confidence interval around the global average land and ocean temperature

Fuente: <https://berkeleyearth.org/data/>

Descarga: <https://www.kaggle.com/datasets/berkeleyearth/climate-change-earth-surface-temperature-data>

```{r}
## Carga de Archivos
GlobalLandTemperaturesByCountry <- read.csv("./GlobalLandTemperaturesByCountry.csv")
GlobalLandTemperaturesByCity <- read.csv("./GlobalLandTemperaturesByCity.csv")
GlobalLandTemperaturesByMajorCity <- read.csv("./GlobalLandTemperaturesByMajorCity.csv")
GlobalLandTemperaturesByState <- read.csv("./GlobalLandTemperaturesByState.csv")
GlobalTemperatures <- read.csv("./GlobalTemperatures.csv")
```

### Temperaturas de la superficie terrestre por Pais

Tiene 4 columnas y 577.462 registros. Existen 32.651 y 31.912 valores nulos en Tempratura Promedio e Intertidumbre de la temperatura media respectivamente.

```{r}
summary(GlobalLandTemperaturesByCountry)
```

### Temperaturas de la superficie terrestre

Tiene 7 columnas Columnas:

-   dt: fecha del registro

-   AverageTemperature: Temperatura promedio

-   AverageTemperatureUncertainty: Promedio del valor de incertidumbre de la temperatura promedio

-   City: Ciudad

-   Country: Pais de la ciudad

-   Latitude: Coordenada de Latitud

-   Longitude Coordenada de Longitud

Se encuentran 8.599.212 registros. Donde existen 364.130 registros nulos en AverageTemperature y

AverageTemperatureUncertainty

```{r}
summary(GlobalLandTemperaturesByCity)
```

### Temperaturas de la superficie terrestre por ciudad capital.

Posee las mismas Columnas que el anterior frame para un total de 7. El numero de registros es menor siendo 239.177

Existen nulos en las columnas AverageTemperature y AverageTemperatureUncertainty con un total de 11.002 para ambos

```{r}
summary(GlobalLandTemperaturesByMajorCity)
```

### Temperaturas por Estado/Departamento/Provincia

Esta tabla tiene 5 columnas: dt, AverageTemperature, AverageTemperatureUncertainty, State, Country

Tiene 645.675 registros donde existen 25.648 registros nulos en AverageTemperature y AverageTemperatureUncertainty

```{r}
summary(GlobalLandTemperaturesByState)
```

```{r}
rm(GlobalLandTemperaturesByCountry)
rm(GlobalLandTemperaturesByMajorCity)
```

## Análisis descriptivo simple

Analizaremos los 8.234.082 de registros después de eliminar los registros con datos nulos

```{r}
# Voy a usar el frame de temperaturas por ciudad y eliminando los datos con nulos.
GlobalLandTemperaturesByCity <- na.omit(GlobalLandTemperaturesByCity)
summary(na.omit(GlobalLandTemperaturesByCity))
GlobalLandTemperaturesByCity$dt<-strptime(GlobalLandTemperaturesByCity$dt,"%Y-%m-%d")
plot(GlobalLandTemperaturesByCity)
```

### Tabla de Frecuencias

Usare Hist los datos numericos y un grafico de barras usando ggplotp para poder graficas los valores categoricos.

Ciudad posiblemente no se puedan ver o distinguir los nombres pero nos dara una idea del comportamiento de la variable.

```{r}
hist(GlobalLandTemperaturesByCity$AverageTemperature)
hist(GlobalLandTemperaturesByCity$AverageTemperatureUncertainty)
ggplot(GlobalLandTemperaturesByCity, aes(x=reorder(GlobalLandTemperaturesByCity$Latitude, GlobalLandTemperaturesByCity$Latitude, function(x)-length(x)))) + geom_bar(fill='red') +  labs(x='Latitude')
ggplot(GlobalLandTemperaturesByCity, aes(x=reorder(GlobalLandTemperaturesByCity$Longitude, GlobalLandTemperaturesByCity$Longitude, function(x)-length(x)))) + geom_bar(fill='red') +  labs(x='Longitude')
```

Revisare mejor la distribucion de los datos usando boxplot debido a que la cantidad de datos afectan las graficas de puntos.

### Temperatura Promedio

```{r}
boxplot(GlobalLandTemperaturesByCity$AverageTemperature,
  ylab = "Temperatura Promedio"
)
summary(GlobalLandTemperaturesByCity$AverageTemperature)
sprintf("Desviacion Estandar: %s",sd(GlobalLandTemperaturesByCity$AverageTemperature))
sprintf("Varianza: %s",var(GlobalLandTemperaturesByCity$AverageTemperature))
```

### Incertidumbre de la Temperatura Promedio

```{r}
boxplot(GlobalLandTemperaturesByCity$AverageTemperatureUncertainty,
  ylab = "Incertidumbre de Temperatura Promedio"
)
summary(GlobalLandTemperaturesByCity$AverageTemperatureUncertainty)
sprintf("Desviacion Estandar: %s",sd(GlobalLandTemperaturesByCity$AverageTemperatureUncertainty))
sprintf("Varianza: %s",var(GlobalLandTemperaturesByCity$AverageTemperatureUncertainty))
```

Tengo el problema pendiente de manejar las coordenadas apropiadamente, lo siguiente que hare es extraer el valor numerico del string de la coordenada y extraer su orientacion ('W', 'E) en una nueva columna y analizar su distribucion.

```{r}
library(stringr)
GlobalLandTemperaturesByCity$LatitudeOr <- str_extract(GlobalLandTemperaturesByCity$Latitude, "[A-Z]+")
GlobalLandTemperaturesByCity$LongitudeOr <- str_extract(GlobalLandTemperaturesByCity$Longitude, "[A-Z]+")
ggplot(GlobalLandTemperaturesByCity, aes(x=reorder(GlobalLandTemperaturesByCity$LatitudeOr, GlobalLandTemperaturesByCity$LatitudeOr, function(x)-length(x)))) + geom_bar(fill='red') +  labs(x='LatitudeOr')
ggplot(GlobalLandTemperaturesByCity, aes(x=reorder(GlobalLandTemperaturesByCity$LongitudeOr, GlobalLandTemperaturesByCity$LongitudeOr, function(x)-length(x)))) + geom_bar(fill='red') +  labs(x='LongitudeOr')

```

Dada la anterior grafica no necesito la orientación, solamente la coordenada numérica. Procedo a eliminar las columnas `LongitudeOr` y `LatitudeOr` creadas y a limpiar las características

```{r}
GlobalLandTemperaturesByCity$Latitude <- as.numeric(str_extract(GlobalLandTemperaturesByCity$Latitude, "[0-9]+"))
GlobalLandTemperaturesByCity$Longitude <- as.numeric(str_extract(GlobalLandTemperaturesByCity$Longitude, "[0-9]+"))
```

```{r}
GlobalLandTemperaturesByCity <- GlobalLandTemperaturesByCity[-c(8,9)]
```

### Longitud

```{r}
boxplot(GlobalLandTemperaturesByCity$Longitude,
  ylab = "Longitud"
)
summary(GlobalLandTemperaturesByCity$Longitude)
sprintf("Desviacion Estandar: %s",sd(GlobalLandTemperaturesByCity$Longitude))
sprintf("Varianza: %s",var(GlobalLandTemperaturesByCity$Longitude))
```

### Latitud

```{r}
boxplot(GlobalLandTemperaturesByCity$Latitude,
  ylab = "Latitud"
)
summary(GlobalLandTemperaturesByCity$Latitude)
sprintf("Desviacion Estandar: %s",sd(GlobalLandTemperaturesByCity$Latitude))
sprintf("Varianza: %s",var(GlobalLandTemperaturesByCity$Latitude))
```

### Date

Viendo que el modelo solo recibe valores numerícos necesito transformar el objeto fecha y descomponerlo en año, mes y día

```{r}
GlobalLandTemperaturesByCity$dt_year <- as.numeric(year(GlobalLandTemperaturesByCity$dt))
GlobalLandTemperaturesByCity$dt_month <- as.numeric(month(GlobalLandTemperaturesByCity$dt))
GlobalLandTemperaturesByCity$dt_day <- as.numeric(day(GlobalLandTemperaturesByCity$dt))
head(GlobalLandTemperaturesByCity)
```

```{r}
summary(GlobalLandTemperaturesByCity)
```

### Comportamiento de las variables vs Variable Objetivo

```{r}
plotHist <- function(data_in, i) {
  data <- data.frame(x=data_in[[i]])
  p <- ggplot(data=data, aes(x=factor(x))) + stat_count() + xlab(colnames(data_in)[i]) + theme_light() + 
    theme(axis.text.x = element_text(angle = 90, hjust =1))
  return (p)
}

doPlots <- function(data_in, fun, ii, ncol=3) {
  pp <- list()
  for (i in ii) {
    p <- fun(data_in=data_in, i=i)
    pp <- c(pp, list(p))
  }
  do.call("grid.arrange", c(pp, ncol=ncol))
}


plotDen <- function(data_in, i){
  data <- data.frame(x=data_in[[i]], AverageTemperature = data_in$AverageTemperature)
  p <- ggplot(data= data) + geom_line(aes(x = x), stat = 'density', size = 1,alpha = 1.0) +
    xlab(paste0((colnames(data_in)[i]), '\n', 'Skewness: ',round(skewness(data_in[[i]], na.rm = TRUE), 2))) + theme_light() 
  return(p)
   
}
```

#### Densidad Final de los datos

Es necesario filtrar para tener los datos del ultimo siglo. Existe informacion desde antes de 1780 por lo que solo tendre los ultimos \~100 años..

Esto dejará solamente 4.788.080 Registros de los iniciales.

```{r}
# Antes de Filtrar
doPlots(GlobalLandTemperaturesByCity[-c(1,4,5)], fun = plotDen, ii = 1:7, ncol = 2)
GlobalLandTemperaturesByCity <- GlobalLandTemperaturesByCity[GlobalLandTemperaturesByCity$dt_year>=1900,]
# Después de Filtrar
doPlots(GlobalLandTemperaturesByCity[-c(1,4,5)], fun = plotDen, ii = 1:7, ncol = 2)
```

Encontramos que existe un error para el cálculo del sesgo en dt_day, esto significa que todos los valores de dt_day es el mismo. 01. Eliminaremos esta variable

```{r}
GlobalLandTemperaturesByCity<-GlobalLandTemperaturesByCity[-c(10)]
```

#### Correlación

Es posible que nos enfrentemos a un problema de multicolinealidad dado a que la latitud es la principal razon en determinar la temperatura promedio. Dada la geografia cada vez que ascendemos mas o hay ciudad con mayor o menor altitud aumenta o disminuye significativamente la temperatura esto indica a que la ciudad siendo mas precisa que la longitud/latitud puede estar altamente correlacionada.

```{r}
head(GlobalLandTemperaturesByCity)
correlations <- cor(GlobalLandTemperaturesByCity[-c(1,4,5)])
corrplot(correlations, method="square")
```

```{r}
plotCorr <- function(data_in, i){
  data <- data.frame(x = data_in[[i]], AverageTemperature = data_in$AverageTemperature)
  p <- ggplot(data, aes(x = x, y = AverageTemperature)) + geom_point(shape = 1, na.rm = TRUE) + geom_smooth(method = lm ) + xlab(paste0(colnames(data_in)[i], '\n', 'R-Squared: ', round(cor(data_in[[i]], data$AverageTemperature, use = 'complete.obs'), 2))) + theme_light()
  return(suppressWarnings(p))
}

highcorr <- c(names(correlations[,'AverageTemperature'])[which(correlations[,'AverageTemperature'] > 0.1)], names(correlations[,'AverageTemperature'])[which(correlations[,'AverageTemperature'] < -0.1)])
 
data_corr <- GlobalLandTemperaturesByCity[,highcorr]


doPlots(data_corr, fun = plotCorr, ii = 2:3)
```

### Nuevas variables de Temperatura Globales

Realizo un left join para obtener las variables globales de ese año que se relacionan con la temperatura, teniendo como index la fecha `dt`.

```{r}
GlobalTemperatures <- na.omit(GlobalTemperatures)
GlobalTemperatures$dt<-strptime(GlobalTemperatures$dt,"%Y-%m-%d")
data = left_join(GlobalLandTemperaturesByCity,GlobalTemperatures, by='dt')
rm(GlobalLandTemperaturesByCity)
rm(GlobalTemperatures)
rm(GlobalLandTemperaturesByState)
data <- data[-c(3,11,13,15,17)]
```

#### Correlación con nuevas variables

```{r}
doPlots(data[-c(1,4,5)], fun = plotDen, ii = 1:6, ncol = 2)
doPlots(data[-c(1,4,5)], fun = plotDen, ii = 7:9, ncol = 2)
```

```{r}
correlations <- cor(data[-c(1,3,4)])
colnames(correlations)
corrplot(correlations, method="square")
```

# Referencias

[1] M. Dell, B. F. Jones and B. A. Olken, "What Do We Learn from the Weather? The New Climate-Economy Literature," *Journal of Economic Literature,* vol. 52, *(3),* pp. 740-798, 2014. Available: <https://universidadviu.idm.oclc.org/login?url=https://www-proquest-com.universidadviu.idm.oclc.org/scholarly-journals/what-do-we-learn-weather-new-climate-economy/docview/1562496152/se-2.> DOI: <https://doi-org.universidadviu.idm.oclc.org/10.1257/jel.52.3.740.>

[2] European Centre for Medium-Range Weather Forecasts ECMWF : Integrated Forecasting System (IFS) Long range, 2020. Available: <https://apps.ecmwf.int/webapps/opencharts/?facets=%7B%22Product%20type%22%3A%5B%5D%2C%22Parameters%22%3A%5B%5D%2C> %22Range%22%3A%5B%22Long%20%28Months%29%22%5D%2C%22Type%22%3A%5B%5D%7D
